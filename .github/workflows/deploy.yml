name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy and Setup Server
        uses: appleboy/ssh-action@master
        # 1. We must define the token environment variable here first
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # 2. Now we explicitly pass that variable to the remote script
          envs: GITHUB_TOKEN
          script: |
            # --- VARIABLES ---
            # 3. FIX: We insert the token into the URL here
            # "x-access-token" is the username, and the variable $GITHUB_TOKEN is the password
            REPO_URL="https://x-access-token:$GITHUB_TOKEN@github.com/LochaniRanasinghe/currency-converter.git"

            PROJECT_DIR="/home/ubuntu/currency-converter"

            # --- STEP 1: INSTALL DOCKER (If not installed) ---
            if ! command -v docker &> /dev/null; then
                echo "Docker not found. Installing..."
                sudo apt-get update
                sudo apt-get install -y docker.io docker-compose
                # Add user to docker group
                sudo usermod -aG docker $USER
                echo "Docker installed."
            else
                echo "Docker is already installed."
            fi

            # --- STEP 2: CLONE OR PULL CODE ---
            if [ ! -d "$PROJECT_DIR" ]; then
                echo "Project folder not found. Cloning..."
                git clone $REPO_URL $PROJECT_DIR
            else
                echo "Project folder exists. Pulling latest code..."
                cd $PROJECT_DIR
                # We update the remote URL just in case the token changed or was missing
                git remote set-url origin $REPO_URL
                git pull origin main
            fi

            # --- STEP 3: DEPLOY APP ---
            cd $PROJECT_DIR

            # Clean up old Docker images
            echo "Cleaning up old Docker images..."
            sudo docker system prune -a -f --volumes

            # Write the .env file from Secrets
            echo "${{ secrets.ENV_FILE }}" > .env

            # Start Containers
            sudo docker-compose up -d --build

            # Wait for a while to ensure DB is ready
            echo "Waiting 30 seconds for Database to start..."
            sleep 30

            # Run Laravel Commands
            sudo docker-compose exec -T app composer install --no-dev --optimize-autoloader
            sudo docker-compose exec -T app php artisan migrate --force
            sudo docker-compose exec -T app php artisan config:cache
            sudo docker-compose exec -T app php artisan route:cache
            sudo docker-compose exec -T app php artisan view:cache
            sudo docker-compose exec -T app php artisan queue:restart
            sudo docker-compose exec -T app chmod -R 777 storage bootstrap/cache

            echo "Deployment Finished Successfully!"
