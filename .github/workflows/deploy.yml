name: Deploy to EC2
 
on:
  push:
    branches:
      - main
 
jobs:
  deploy:
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
 
      - name: Deploy and Setup Server
        uses: appleboy/ssh-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GITHUB_TOKEN
          script: |
            # --- VARIABLES ---
            REPO_URL="https://x-access-token:$GITHUB_TOKEN@github.com/LochaniRanasinghe/currency-converter.git"
            PROJECT_DIR="/home/ubuntu/currency-converter"
 
            # --- STEP 1: INSTALL DOCKER (If not installed) ---
            if ! command -v docker &> /dev/null; then
                echo "Docker not found. Installing..."
                sudo apt-get update
                sudo apt-get install -y docker.io docker-compose
                sudo usermod -aG docker $USER
                echo "Docker installed."
            else
                echo "Docker is already installed."
            fi
 
            # --- STEP 2: CLONE OR PULL CODE ---
            if [ ! -d "$PROJECT_DIR" ]; then
                echo "Project folder not found. Cloning..."
                git clone $REPO_URL $PROJECT_DIR
            else
                echo "Project folder exists. Pulling latest code..."
                cd $PROJECT_DIR
                git remote set-url origin $REPO_URL
                git pull origin main
            fi
 
            # --- STEP 3: DEPLOY APP ---
            cd $PROJECT_DIR
 
            # Clean up old Docker images
            sudo docker system prune -a -f --volumes
 
            # Write the .env file from Secrets
            echo "${{ secrets.ENV_FILE }}" > .env
 
            # Start Containers
            sudo docker-compose up -d --build
 
            # Wait for Database to be ready
            echo "Waiting 30 seconds for Database to start..."
            sleep 30
 
            # --- STEP 4: LARAVEL SETUP & PERMISSION FIX ---
 
            # 1. Install Dependencies (Creates files as ROOT)
            sudo docker-compose exec -T app composer install --no-dev --optimize-autoloader
 
            # 2. Run Migrations & Cache
            sudo docker-compose exec -T app php artisan migrate --force
            sudo docker-compose exec -T app php artisan config:cache
            sudo docker-compose exec -T app php artisan route:cache
            sudo docker-compose exec -T app php artisan view:cache
 
            # 3. CRITICAL FIX: Change Ownership to www-data
            # This fixes the issue where Nginx cannot read the 'vendor' folder
            echo "Fixing permissions..."
            sudo docker-compose exec -T app chown -R www-data:www-data /var/www/vendor
            sudo docker-compose exec -T app chown -R www-data:www-data /var/www/storage
            sudo docker-compose exec -T app chown -R www-data:www-data /var/www/bootstrap/cache
 
            # 4. Ensure directories are writable
            sudo docker-compose exec -T app chmod -R 775 /var/www/storage /var/www/bootstrap/cache
 
            # 5. Restart Queue Worker (To load new code/vendor files)
            sudo docker-compose restart worker
 
            echo "Deployment Finished Successfully!"
 
 